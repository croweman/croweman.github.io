<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Book Keeping</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="bootstrap.min.css">

    <style type="text/css">
        .clear {
            clear: both;
        }
        .inputMargin {
            margin-top:5px;
        }
        .marginBottom {
            margin-bottom: 5px;
        }
        #customerDetails, #bookEntries, #bookEntry, #createCustomerError, #searchError, #results, #findCustomer, #createBookEntryError, #tools, #expense, #expenses, #customers, #settings {
            display: none;
        }

        #bookEntry {
            display: none;
        }

        input[type=file] {
            display: inline-block;
        }

        body {
            margin-bottom: 20px;
        }

        .has-danger {
            color: #d9534f;
        }

        .has-danger .form-control {
            border-color: #d9534f;
        }

        .has-success {
            color: #5cb85c;
        }

        .has-success .form-control {
            border-color: #5cb85c;
        }

        .navbar-brand-item {
            font-size: 15px;
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 16px;
        }

        .topNavDropDownItem {
            color: white!important;
        }

        .createButtons, #expensesButtons {
            margin-bottom: 20px;
            margin-left: 0; 
            padding-left: 0;
        }

        #dateFiltering .panel-body {
            padding-top: 0;
        }

        input[type=file]::-webkit-file-upload-button {
            color: #fff;
            background-color: #337ab7;
            border-color: #2e6da4;
            display: inline-block;
            margin-bottom: 0;
            font-weight: 400;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            -ms-touch-action: manipulation;
            touch-action: manipulation;
            cursor: pointer;
            background-image: none;
            border: 1px solid transparent;
            padding: 6px 12px;
            font-size: 14px;
            line-height: 1.42857143;
            border-radius: 4px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #progress {
            display:none;
            margin-top:20px;
        }

    </style>

    <script type="text/JavaScript">
        var openRequest;
        var db;
        var miles = 0;
        var timeOptions = [];
        var bookEntry;
        var customer;
        var allCustomers = [];
        var monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];
        var defaultWhen = getWhen(new Date());
        var costPerMile = 0.45;
        var currentView = 'entries';
        var setting;

        function updateValidationIndicator(id, valid) {
            if (valid) {
                $('#' + id + 'Container').addClass('has-success');
            } else {
                $('#' + id + 'Container').addClass('has-danger');
            }
        }

        function hasValue(value) {
            return value.trim().length > 0;
        }

        function hasValidMoneyValue(value) {
            let moneyRegEx = new RegExp(/^[0-9]+(\.[0-9]{2}){0,1}$/);

            return moneyRegEx.test(value);
        }

        function hasValidMilesValue(value) {
            let milesRegEx = new RegExp(/^[0-9]+(\.[0-9]{1,2}){0,1}$/);

            return milesRegEx.test(value);
        }

        function hasValidInteger(value) {
            let intRegEx = new RegExp(/^\d+$/);

            return intRegEx.test(value);
        }

        function validate(id, validation) {
            var value = $('#' + id).val();
            var valid = validation(value);
            updateValidationIndicator(id, valid);
        }

        function addValidation(id, validation) {
            $('#' + id).blur(function() {
                validate(id, validation);
            });

            $('#' + id).change(function() {
                validate(id, validation);
            });
        }

        function scrollToTop() {
            $('#scrollTo')[0].scrollIntoView();
        }

        function addCustomer(customer, successCallback) {
            var customersTransaction = db.transaction("customer", "readwrite");
            var customersStore = customersTransaction.objectStore('customer');

            let request = customersStore.add(customer);

            request.onsuccess = successCallback;
        }

        function addSetting(setting, successCallback) {
            var settingTransaction = db.transaction("settings", "readwrite");
            var settingStore = settingTransaction.objectStore('settings');

            let request = settingStore.add(setting);

            request.onsuccess = successCallback;
        }

        function addBookEntry(bookEntry, successCallback) {
            var bookyEntryTransaction = db.transaction("bookEntry", "readwrite");
            var bookEntryStore = bookyEntryTransaction.objectStore('bookEntry');

            let request = bookEntryStore.add(bookEntry);

            request.onsuccess = successCallback;
        }

        function addExpense(expense, successCallback) {
            var expenseTransaction = db.transaction("expenses", "readwrite");
            var expenseStore = expenseTransaction.objectStore('expenses');

            var request = expenseStore.add(expense);

            request.onsuccess = successCallback;
        }

        function updateBookEntryRecord(bookEntry, successCallback) {
            var bookyEntryTransaction = db.transaction("bookEntry", "readwrite");
            var bookEntryStore = bookyEntryTransaction.objectStore('bookEntry');

            var request = bookEntryStore.put(bookEntry);

            request.onsuccess = successCallback;
        }

        function updateCustomerRecord(customer, successCallback) {
            var customerTransaction = db.transaction("customer", "readwrite");
            var customerStore = customerTransaction.objectStore('customer');

            var request = customerStore.put(customer);

            request.onsuccess = successCallback;
        }

        function updateSettingRecord(setting, successCallback) {
            var settingTransaction = db.transaction("settings", "readwrite");
            var settingStore = settingTransaction.objectStore('settings');

            var request = settingStore.put(setting);

            request.onsuccess = successCallback;
        }

        function updateExpenseRecord(expense, successCallback) {
            var expenseTransaction = db.transaction('expenses', 'readwrite');
            var expenseStore = expenseTransaction.objectStore('expenses');

            var request = expenseStore.put(expense);
            
            request.onsuccess = successCallback;
        }

        function dateFiltersChanged() {
            if (currentView === 'entries') {
                populateBookEntries();
            }

            if (currentView === 'expenses') {
                expenses();
            }
        }

        function dateFilters() {
            $('#fromDate').change(function() {
                dateFiltersChanged();
            });

            $('#toDate').change(function() {
                dateFiltersChanged();
            });
        }

        function createCustomer() {

            addValidation('name', hasValue);
            addValidation('addressLine1', hasValue);
            addValidation('town', hasValue);
            addValidation('postcode', hasValue);
            addValidation('miles', hasValidMilesValue);

            function createCustomerModalClick() {
                $('#bookEntries').hide();
                $('#bookEntry').hide();
                $('#findCustomer').hide();
                $('#createCustomerError').hide();
                $('#customers').hide();
                $('#name').val('');
                $('#addressLine1').val('');
                $('#town').val('March');
                $('#postcode').val('-');
                $('#miles').val('0');
                $('#createCustomer').show();
                $('#updateCustomer').hide();
                $('#customerDetails').show();

                removeValidationStatus('name');
                removeValidationStatus('addressLine1');
                removeValidationStatus('town');
                removeValidationStatus('postcode');
                removeValidationStatus('miles');

                $('#name').focus();
            }

            $('#createCustomerModal').click(createCustomerModalClick);
            $('#createCustomerModal2').click(createCustomerModalClick);
            $('#createCustomerModal3').click(createCustomerModalClick);

            $('#createCustomer').click(function() {
                $('#createCustomerError').hide();
                var name = $('#name').val().trim();
                var addressLine1 = $('#addressLine1').val().trim();
                var town = $('#town').val().trim();
                var postcode = $('#postcode').val().trim();
                var miles = $('#miles').val().trim();

                let milesRegEx = new RegExp(/^[0-9]+(\.[0-9]{1,2}){0,1}$/);

                validate('name', hasValue);
                validate('addressLine1', hasValue);
                validate('town', hasValue);
                validate('postcode', hasValue);
                validate('miles', hasValidMilesValue);

                if (name.length === 0 || addressLine1.length === 0 || town.length === 0 || postcode.length === 0 || !milesRegEx.test(miles)) {
                    //$('#createCustomerError').show();
                    return;
                }

                var customer = {
                    name: name,
                    addressLine1: addressLine1,
                    town: town,
                    postcode: postcode,
                    miles: parseFloat(miles),
                    full: (name + addressLine1 + town + postcode).toLowerCase()
                };
                
                addCustomer(customer, function() {
                    getAllCustomers(function(custs) {
                        allCustomers = custs;
                        $('#customerDetails').hide();
                        scrollToTop();
                        customers();
                    });
                });
            });
        }

        function editCustomer(id) {
            getCustomerById(id, function(customerInstance) {
                customer = customerInstance;
                $('#bookEntries').hide();
                $('#createCustomerError').hide();
                $('#customerDetails').hide();
                $('#findCustomer').hide();
                $('#bookEntry').hide();
                $('#createBookEntry').hide();
                $('#customers').hide();

                $('#createCustomer').hide();
                $('#updateCustomer').show();
                $('#customerDetails').show();

                $('#name').val(customer.name);
                $('#addressLine1').val(customer.addressLine1);
                $('#town').val(customer.town);
                $('#postcode').val(customer.postcode);
                $('#miles').val(customer.miles);

                removeValidationStatus('name');
                removeValidationStatus('addressLine1');
                removeValidationStatus('town');
                removeValidationStatus('postcode');
                removeValidationStatus('miles');

                $('#name').focus();
            });
        }

        function updateCustomer() {
            $('#updateCustomer').click(function() {
                var name = $('#name').val().trim();
                var addressLine1 = $('#addressLine1').val().trim();
                var town = $('#town').val().trim();
                var postcode = $('#postcode').val().trim();
                var miles = $('#miles').val().trim();

                let milesRegEx = new RegExp(/^[0-9]+(\.[0-9]{1,2}){0,1}$/);

                validate('name', hasValue);
                validate('addressLine1', hasValue);
                validate('town', hasValue);
                validate('postcode', hasValue);
                validate('miles', hasValidMilesValue);

                if (name.length === 0 || addressLine1.length === 0 || town.length === 0 || postcode.length === 0 || !milesRegEx.test(miles)) {
                    //$('#createCustomerError').show();
                    return;
                }

                customer.name = name;
                customer.addressLine1 = addressLine1;
                customer.town = town;
                customer.postcode = postcode;
                customer.miles = parseFloat(miles);
                customer.full = (name + addressLine1 + town + postcode).toLowerCase();

                updateCustomerRecord(customer, function() {

                    getAllBookEntries(function(bookEntries) {
                        var numberOfBookEntriesToUpdate = 0;
                        var numberOfBookEntriesUpdated = 0;

                        bookEntries.forEach(function(bookEntry) {
                            if (bookEntry.customerId !== customer.id) return;
                            
                            bookEntry.customerId = customer.id;
                            bookEntry.customer = customer.name + ', ' + customer.addressLine1 + ', ' + customer.town;
                            bookEntry.miles = customer.miles;

                            numberOfBookEntriesToUpdate++;

                            updateBookEntryRecord(bookEntry, function() {
                                numberOfBookEntriesUpdated++;
                            });
                        });
                    
                        var interval = setInterval(() => {
                            if (numberOfBookEntriesUpdated === numberOfBookEntriesToUpdate) {
                                clearInterval(interval);
                                $('#customerDetails').hide();
                                scrollToTop();
                                customers();
                            }
                        }, 100);
                    });
                });
            });
        }

        function createBookEntry() {

            addValidation('customer', hasValue);
            addValidation('when', hasValue);
            addValidation('summary', hasValue);
            addValidation('amount', hasValidMoneyValue);

            function createBookEntryModalScreen() {
                $('#createBookEntry').show();
                $('#updateBookEntry').hide();
                $('#bookEntries').hide();
                $('#createBookEntryError').hide();
                $('#customerDetails').hide();
                $('#findCustomer').hide();
                $('#customers').hide();
                $('#bookEntry').show();

                removeValidationStatus('customer');
                removeValidationStatus('when');
                removeValidationStatus('amount');
                removeValidationStatus('summary');

                $('#customerId').val('');
                $('#customer').val('');
                $('#when').val(defaultWhen);
                document.getElementById('whenTime').selectedIndex = 0;
                $('#amount').val('');
                $('#summary').val('');
                $('#when').focus();
            }

            $('#createBookEntryModal').click(createBookEntryModalScreen);
            $('#createBookEntryModal2').click(createBookEntryModalScreen);

            $('#customer').click(function() {
                $('#bookEntry').hide();
                showFindCustomer();
            });

            $('#createBookEntry').click(function() {
                var customerId = $('#customerId').val().trim();
                var customer = $('#customer').val().trim();
                var when = $('#when').val();
                var whenTime = $('#whenTime').val();
                var amount = $('#amount').val();
                var summary = $('#summary').val();

                let moneyRegEx = new RegExp(/^[0-9]+(\.[0-9]{2}){0,1}$/);

                validate('customer', hasValue);
                validate('when', hasValue);
                validate('summary', hasValue);
                validate('amount', hasValidMoneyValue);

                var valid = customerId.length > 0 && when.length > 0 && moneyRegEx.test(amount) && summary.length > 0;

                if (!valid) {
                    //$('#createBookEntryError').show();
                    return;
                }

                if (miles === undefined || miles === null)
                    miles = 0;

                var bookEntry = {
                    customer: customer,
                    customerId: parseInt(customerId),
                    when: new Date(when + 'T' + whenTime),
                    summary: summary,
                    amount: parseFloat(amount),
                    miles: parseFloat(miles)
                };

                addBookEntry(bookEntry, function(e) {
                    bookEntry.id = e.target.result;
                    $('#bookEntry').hide();
                    scrollToTop();
                    populateBookEntries([ bookEntry ], true);
                });
            });
        }

        function editBookEntry(id, milesVal) {
            miles = milesVal;
            getBookEntryById(id, function(bookEntryInstance) {
                bookEntry = bookEntryInstance;
                $('#bookEntries').hide();
                $('#createBookEntryError').hide();
                $('#customerDetails').hide();
                $('#findCustomer').hide();
                $('#bookEntry').show();
                $('#createBookEntry').hide();
                $('#customers').hide();
                $('#updateBookEntry').show();

                $('#customerId').val(bookEntry.customerId);
                $('#customer').val(bookEntry.customer);
                var when = bookEntry.when.toISOString();
                var date = when.substr(0, when.indexOf('T'));
                $('#when').val(date);
                $('#amount').val(bookEntry.amount.toFixed(2));
                $('#summary').val(bookEntry.summary);

                document.getElementById('whenTime').selectedIndex = 0;

                var time = when.substr(when.indexOf('T') + 1);
                time = time.substr(0, 5);

                for (var i = 0; i < timeOptions.length; i++) {
                    if (timeOptions[i].text === time) {
                        document.getElementById('whenTime').selectedIndex = i;
                        break;
                    }
                }

                removeValidationStatus('customer');
                removeValidationStatus('when');
                removeValidationStatus('amount');
                removeValidationStatus('summary');

                $('#when').focus();
            })
        }

        function updateBookEntry() {
            $('#updateBookEntry').click(function() {
                var customerId = $('#customerId').val().trim();
                var customer = $('#customer').val().trim();
                var when = $('#when').val();
                var whenTime = $('#whenTime').val();
                var amount = $('#amount').val();
                var summary = $('#summary').val();

                let moneyRegEx = new RegExp(/^[0-9]+(\.[0-9]{2}){0,1}$/);

                validate('customer', hasValue);
                validate('when', hasValue);
                validate('summary', hasValue);
                validate('amount', hasValidMoneyValue);

                var valid = customerId.length > 0 && when.length > 0 && moneyRegEx.test(amount) && summary.length > 0;

                if (!valid) {
                    //$('#createBookEntryError').show();
                    return;
                }

                if (miles === undefined || miles === null)
                    miles = 0;

                bookEntry.customer = customer;
                bookEntry.customerId = parseInt(customerId);
                bookEntry.when = new Date(when + 'T' + whenTime);
                bookEntry.summary = summary;
                bookEntry.amount = parseFloat(amount);
                bookEntry.miles = parseFloat(miles);

                updateBookEntryRecord(bookEntry, function() {
                    $('#bookEntry').hide();
                    scrollToTop();
                    populateBookEntries([ bookEntry ], true);
                });
            });
        }

        function showFindCustomer() {
            $('#findCustomer').show();
            $('#filter').val('');
            $('#resultsBody').empty();
            $('#results').hide();
            $('#filter').focus();
            scrollToTop();
        }

        function findCustomer() {
            $('#resultsBody').empty();
            $('#searchError').hide();

            var filter = $('#filter').val().trim().toLowerCase();

            if (filter.length === 0) {
                return;
            }

            var html = '';

            var customers = allCustomers.filter(function(item) {return item.full.indexOf(filter) !== -1; });

            customers.forEach(function(customer) {
                html += '<tr><td><input type="radio" name="customerradio" onclick="javascript:selectChosenCustomer();" value="' + customer.id + '" data-miles="' + customer.miles + '" data-summary="' + customer.name + ', ' + customer.addressLine1 + ', ' + customer.town + '"></td><td>' + customer.name  + '</td><td>' + customer.addressLine1  + '</td><td>' + customer.town + '</td></tr>';
            });

            $('#results').show();
            $('#resultsBody').append(html);
        }

        function findCustomer2() {
            $('#customersBody').empty();

            var filter = $('#customerFilter').val().trim().toLowerCase();

            if (filter.length === 0) {
                return;
            }

            var html = '';

            var customers = allCustomers.filter(function(item) {return item.full.indexOf(filter) !== -1; });

            customers.forEach(function(customer) {
                html += getCustomerRow(customer);
            });

            $('#customersBody').append(html);
        }

        function removeValidationStatus(id) {
            $('#' + id + 'Container').removeClass('has-success')
            $('#' + id + 'Container').removeClass('has-danger')
        }

        function selectChosenCustomer() {
            var input = $("input:radio[name='customerradio']:checked");

            var id = input.val();

            if (id === undefined) return;

            $('#findCustomer').hide();
            $('#bookEntry').show();
    
            $('#customerId').val(id);
            $('#customer').val(input.data().summary);
            removeValidationStatus('customer');
            $('#customerContainer').addClass('has-success')
            $('#createBookEntryError').hide();
            miles = parseFloat(input.data().miles)
        };

        function createExpense() {

            addValidation('expenseWhen', hasValue);
            addValidation('expenseSupplier', hasValue);
            addValidation('expenseSummary', hasValue);
            addValidation('expenseAmount', hasValidMoneyValue);
            addValidation('expenseMiles', hasValidMilesValue);

            $('#createExpenseModal').click(function() {
                $('#createBookEntry').show();
                $('#updateBookEntry').hide();
                $('#bookEntries').hide();
                $('#createBookEntryError').hide();
                $('#createExpenseError').hide();
                $('#customerDetails').hide();
                $('#findCustomer').hide();
                $('#customers').hide();
                $('#bookEntry').hide();
                $('#createExpense').show();
                $('#updateExpense').hide();
                $('#expenses').hide();

                $('#expense').show();

                var date = new Date().toISOString();
                date = date.substr(0, date.indexOf('T'));
                $('#expenseWhen').val(date);
                $('#expenseSupplier').val('');
                $('#expenseAmount').val('');
                $('#expenseSummary').val('');
                $('#expenseMiles').val('0');

                $('#expenseWhen').focus();

                removeValidationStatus('expenseWhen');
                removeValidationStatus('expenseSupplier');
                removeValidationStatus('expenseSummary');
                removeValidationStatus('expenseAmount');
                removeValidationStatus('expenseMiles');
            });

            $('#createExpense').click(function() {
                var when = $('#expenseWhen').val();
                var amount = $('#expenseAmount').val();
                var supplier = $('#expenseSupplier').val();
                var summary = $('#expenseSummary').val();
                var miles = $('#expenseMiles').val().trim();

                let milesRegEx = new RegExp(/^[0-9]+(\.[0-9]{1,2}){0,1}$/);
                let moneyRegEx = new RegExp(/^[0-9]+(\.[0-9]{2}){0,1}$/);

                validate('expenseWhen', hasValue);
                validate('expenseSupplier', hasValue);
                validate('expenseSummary', hasValue);
                validate('expenseAmount', hasValidMoneyValue);
                validate('expenseMiles', hasValidMilesValue);

                var valid = when.length > 0 && supplier.length > 0 && summary.length > 0 && moneyRegEx.test(amount) && milesRegEx.test(miles);

                if (!valid) {
                    //$('#createExpenseError').show();
                    return;
                }

                if (miles === undefined || miles === null)
                    miles = 0;

                var expense = {
                    when: new Date(when + 'T09:00'),
                    supplier: supplier,
                    summary: summary,
                    amount: parseFloat(amount),
                    miles: parseFloat(miles)
                };

                addExpense(expense, function(e) {
                    expenses();
                });
            });
        }

        function editExpense(id) {
            getExpenseById(id, function(expenseInstance) {
                expense = expenseInstance;
                $('#bookEntries').hide();
                $('#createExpenseError').hide();
                $('#customerDetails').hide();
                $('#findCustomer').hide();
                $('#expense').show();
                $('#createBookEntry').hide();
                $('#customers').hide();
                $('#expenses').hide();
                $('#createExpense').hide();
                $('#updateExpense').show();

                var when = expense.when.toISOString();
                var date = when.substr(0, when.indexOf('T'));

                $('#expenseWhen').val(date);
                $('#expenseAmount').val(expense.amount.toFixed(2));
                $('#expenseSummary').val(expense.summary);
                $('#expenseSupplier').val(expense.supplier);
                $('#expenseMiles').val(expense.miles);

                removeValidationStatus('expenseWhen');
                removeValidationStatus('expenseSupplier');
                removeValidationStatus('expenseSummary');
                removeValidationStatus('expenseAmount');
                removeValidationStatus('expenseMiles');

                $('#expenseWhen').focus();
            });
        }

        function updateExpense() {
            $('#updateExpense').click(function() {
                var when = $('#expenseWhen').val();
                var amount = $('#expenseAmount').val();
                var supplier = $('#expenseSupplier').val();
                var summary = $('#expenseSummary').val();
                var miles = $('#expenseMiles').val().trim();

                let milesRegEx = new RegExp(/^[0-9]+(\.[0-9]{1,2}){0,1}$/);
                let moneyRegEx = new RegExp(/^[0-9]+(\.[0-9]{2}){0,1}$/);

                validate('expenseWhen', hasValue);
                validate('expenseSupplier', hasValue);
                validate('expenseSummary', hasValue);
                validate('expenseAmount', hasValidMoneyValue);
                validate('expenseMiles', hasValidMilesValue);

                var valid = when.length > 0 && supplier.length > 0 && summary.length > 0 && moneyRegEx.test(amount) && milesRegEx.test(amount);

                if (!valid) {
                    //$('#createExpenseError').show();
                    return;
                }

                if (miles === undefined || miles === null)
                    miles = 0;

                expense.when = new Date(when + 'T09:00'),
                expense.supplier = supplier;
                expense.summary = summary;
                expense.amount = parseFloat(amount);
                expense.miles = parseFloat(miles);

                updateExpenseRecord(expense, function() {
                    expenses();
                });
            });
        }

        function createSettings() {
            addValidation('reminderDurationInDays', hasValidInteger);
            addValidation('numberOfMonthsToShow', hasValidInteger);
        }

        function editSettings(id) {
            $('#bookEntries').hide();
            $('#createExpenseError').hide();
            $('#customerDetails').hide();
            $('#findCustomer').hide();
            $('#expense').hide();
            $('#createBookEntry').hide();
            $('#customers').hide();
            $('#expenses').hide();

            $('#settings').show();

            var durationInDays = 30;
            var numberOfMonthsToShow = 3;

            if (setting.durationInDays !== undefined && setting.durationInDays !== null) {
                durationInDays = setting.durationInDays;
            }
                
            if (setting.numberOfMonthsToShow !== undefined && setting.numberOfMonthsToShow !== null) {
                numberOfMonthsToShow = setting.numberOfMonthsToShow;
            }
                
            $('#reminderDurationInDays').val(durationInDays.toString());
            $('#numberOfMonthsToShow').val(numberOfMonthsToShow);

            removeValidationStatus('reminderDurationInDays');
            removeValidationStatus('numberOfMonthsToShow');

            $('#reminderDurationInDays').focus();
        };

        function updateSettings() {
            $('#updateSettings').click(function() {
                var durationInDays = $('#reminderDurationInDays').val().trim();
                var numberOfMonthsToShow = $('#numberOfMonthsToShow').val().trim();

                var intRegEx = new RegExp(/^\d+$/);

                validate('reminderDurationInDays', hasValidInteger);
                validate('numberOfMonthsToShow', hasValidInteger);

                var valid = intRegEx.test(durationInDays) && intRegEx.test(numberOfMonthsToShow);

                if (!valid) {
                    //$('#createExpenseError').show();
                    return;
                }

                setting.durationInDays = parseInt(durationInDays);
                setting.numberOfMonthsToShow = parseInt(numberOfMonthsToShow);

                updateSettingRecord(setting, function() {
                    location.reload();
                });
            });
        }

        function matchesDataFilters(dataFilters, result) {
            return result.when >= dataFilters.fromDate && result.when <= dataFilters.toDate;
        }

        function getFormattedDate(date) {
            var year = date.getFullYear();

            var month = (1 + date.getMonth()).toString();
            month = month.length > 1 ? month : '0' + month;

            var day = date.getDate().toString();
            day = day.length > 1 ? day : '0' + day;

            var hour = date.getHours().toString();
            hour = hour.length > 1 ? hour : '0' + hour
            
            var minute = date.getMinutes().toString();
            minute = minute.length > 1 ? minute : '0' + minute;
            
            return day + '/' + month + '/' + year + ' ' + hour + ':' + minute;
        }

        function getWhen(date) {
            var year = date.getFullYear();

            var month = (1 + date.getMonth()).toString();
            month = month.length > 1 ? month : '0' + month;

            var day = date.getDate().toString();
            day = day.length > 1 ? day : '0' + day;
            
            return year + '-' + month + '-' + day;
        }

        var deleting = false;
        function deleteBookEntry(id) {
            if (deleting) return;

            var result = confirm('Are you sure?');

            if (!result) return;

            deleting = true;
            
            var bookEntriesTransaction = db.transaction("bookEntry", "readwrite");
            var bookEntriesStore = bookEntriesTransaction.objectStore('bookEntry');

            var request = bookEntriesStore.delete(id);

            request.onsuccess = function(event) {
                populateBookEntries();
                deleting = false;
            };
        }

        var deletingExpense = false;
        function deleteExpense(id) {
            if (deletingExpense) return;

            var result = confirm('Are you sure?');

            if (!result) return;

            deletingExpense = true;
            
            var expensesTransaction = db.transaction("expenses", "readwrite");
            var expensesStore = expensesTransaction.objectStore('expenses');

            var request = expensesStore.delete(id);

            request.onsuccess = function(event) {
                expenses();
                deletingExpense = false;
            };
        }

        function getAllBookEntries(successCallback, ignoreDates) {
            var bookEntriesTransaction = db.transaction("bookEntry", "readwrite");
            var bookEntriesStore = bookEntriesTransaction.objectStore('bookEntry');
            var index = bookEntriesStore.index('when');
            var request = index.openCursor(null, ['prev']);

            var results = [];

            request.onsuccess = function() {
                let cursor = request.result;
                var dataFilters = getFromAndToDate();

                if (cursor) {
                    if (ignoreDates || matchesDataFilters(dataFilters, cursor.value)) {
                        results.push(cursor.value);
                    }
                    
                    cursor.continue();
                } else {
                    successCallback(results);
                }
            };
        }

        function getAllSettings(successCallback) {
            var settingsTransaction = db.transaction("settings", "readwrite");
            var settingsStore = settingsTransaction.objectStore('settings');
            var request = settingsStore.getAll();

            var results = [];

            request.onsuccess = function() {
                successCallback(request.result);
            }
        }

        function getFromAndToDate() {
            var fromDate = $('#fromDate').val() + 'T00:00:00';
            var toDate = $('#toDate').val() + 'T23:59:59';

            return {
                fromDate: new Date(fromDate),
                toDate: new Date(toDate)
            };
        }

        function getAllCustomers(successCallback) {
            var customersTransaction = db.transaction("customer", "readwrite");
            var customersStore = customersTransaction.objectStore('customer');
            var index = customersStore.index('full');

            var request = index.openCursor(null, ['next']);
            var results = [];

            request.onsuccess = function() { 
                let cursor = request.result;
                if (cursor) {
                    results.push(cursor.value);
                    cursor.continue();
                } else {
                    successCallback(results);
                }
            };
        }

        function getAllExpenses(successCallback, ignoreDates) {
            var expensesTransaction = db.transaction("expenses", "readwrite");
            var expensesStore = expensesTransaction.objectStore('expenses');
            var index = expensesStore.index('when');
            var request = index.openCursor(null, ['prev']);
            var results = [];

            request.onsuccess = function() { 
                let cursor = request.result;
                var dataFilters = getFromAndToDate();

                if (cursor) {
                    if (ignoreDates || matchesDataFilters(dataFilters, cursor.value)) {
                        results.push(cursor.value);
                    }
                    
                    cursor.continue();
                } else {
                    successCallback(results);
                }
            };
        }

        function getBookEntryById(id, successCallback) {
            var bookEntriesTransaction = db.transaction("bookEntry", "readwrite");
            var bookEntriesStore = bookEntriesTransaction.objectStore('bookEntry');
            var record = bookEntriesStore.get(id);

            record.onsuccess = function() {
                successCallback(record.result);
            };
        }

        function getCustomerById(id, successCallback) {
            var customerTransaction = db.transaction("customer", "readwrite");
            var customerStore = customerTransaction.objectStore('customer');
            var record = customerStore.get(id);

            record.onsuccess = function() {
                successCallback(record.result);
            };
        }

        function getExpenseById(id, successCallback) {
            var expensesTransaction = db.transaction("expenses", "readwrite");
            var expensesStore = expensesTransaction.objectStore('expenses');
            var record = expensesStore.get(id);

            record.onsuccess = function() {
                successCallback(record.result);
            };
        }

        function getDateLabel(date) {
            return monthNames[date.getMonth()] + ' ' + date.getFullYear();
        }

        function toggleTable(tableId) {
            var visible = $('#' + tableId + ':visible').length > 0;
            
            var buttonText = $('#' + tableId + 'Button').text();

            if (visible) {
                $('#' + tableId).hide();
                buttonText = buttonText.substr(0, buttonText.length - 1) + '+';
            } else {
                $('#' + tableId).show();
                buttonText = buttonText.substr(0, buttonText.length - 1) + '-';
            }

            $('#' + tableId + 'Button').text(buttonText);
        }

        function populateBookEntries(providedBookEntries, removeCollapseButton) {
            currentView = 'entries';
            $('#bookEntry').hide();
            $('#customerDetails').hide();
            $('#findCustomer').hide();
            $('#customers').hide();
            $('#tools').hide();
            $('#expenses').hide();
            $('#expense').hide();
            $('#settings').hide();
            $('#dateFiltering').show();
            $('#bookEntries').show();

            $('#bookEntriesSummary').show();

            var html = "";
            var total = 0;
            var totalMiles = 0;
            var totalMilesCost = 0;

            function callback(bookEntries) {
                var data = {};
                var keys = [];

                bookEntries.forEach(function(bookEntry) {
                    var key = getDateLabel(bookEntry.when);
                    
                    if (!data[key]) {
                        data[key] = [];
                        keys.push(key);
                    }

                    data[key].push(bookEntry);
                });

                var expand = true;

                keys.forEach(function(key) {
                    var currentTotal = 0;
                    var currentMiles = 0;
                    var currentMilesCost = 0;

                    data[key].forEach(function(bookEntry) {
                        var miles = bookEntry.miles;

                        if (miles === undefined || miles === null)
                            miles = 0;

                        total += bookEntry.amount;
                        currentTotal += bookEntry.amount;
                        totalMiles += miles;
                        totalMilesCost += (miles * costPerMile);
                        currentMiles += miles;
                        currentMilesCost += (miles * costPerMile);
                    });

                    var tableId = key.replace(' ', '');
                    var entries = data[key].length;
                    var buttonAdditionalText = '&nbsp;&nbsp;(' + entries + ' ' + (entries === 1 ? 'entry' : 'entries') + ')';

                    if (!removeCollapseButton) {
                        html += '<div class="form-group"><button id="' + tableId + 'Button"class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample" onclick="toggleTable(\'' + tableId + '\')">' + key + ' ' + buttonAdditionalText + ' ' + (expand ? '-' : '+') + '</button></div>';
                    }
                    
                    html += '<div id="' + tableId + '"' + (expand ? '' : ' style="display:none"') + ' class="form-group"><label>Income: £' + currentTotal.toFixed(2) + '</label><br /><label>Miles: ' + currentMiles.toFixed(2) + '</label><br /><label>Miles cost: ' + currentMilesCost.toFixed(2) + '</label>';
                    html += '<table class="table"><thead><tr><th>Date</th><th>Customer</th><th>Amount</th><th>Miles</th><th>Summary of work</th><th>Delete</th></tr></thead><tbody>';

                    data[key].forEach(function(bookEntry) {
                        html += '<tr><td><a href="javascript:editBookEntry(' + bookEntry.id  + ', ' + bookEntry.miles + ')">' + getFormattedDate(bookEntry.when) + '</a></td><td>' + bookEntry.customer + '</td><td>£' + bookEntry.amount.toFixed(2) + '</td><td>' + bookEntry.miles.toFixed(2) + '</td><td>' + bookEntry.summary + '</td><td><button type="button" class="btn btn-default" onclick="deleteBookEntry(' + bookEntry.id  + ')">Delete</button></td></tr>';
                    });

                    html += '</tbody></table></div>';
                    expand = false;
                });

                $('#bookEntriesBody').html(html)
                $('#bookEntries').show();
                $('#total').html(total.toFixed(2));
                $('#totalMiles').html(totalMiles.toFixed(2));
                $('#totalMilesCost').html(totalMilesCost.toFixed(2));
            }

            if (providedBookEntries !== undefined) {
                $('#bookEntriesSummary').hide();
                callback(providedBookEntries);
                return;
            }

            getAllBookEntries(callback);
        }

        function download() {
            getAllBookEntries(function(bookEntries) {
                getAllCustomers(function(customers) {
                    getAllExpenses(function(expenses) {
                        getAllSettings(function(settings) {
                            var data = {
                                bookEntries: bookEntries,
                                customers: customers,
                                expenses: expenses
                            };

                            var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
                            var dlAnchorElem = document.getElementById('downloadAnchorElem');
                            dlAnchorElem.setAttribute("href", dataStr);
                            var name = getFormattedDate(new Date());
                            name = name.replace(' ', '_');
                            name = name.replace(':', '-');
                            name = name.replace(/\//g, '-');
                            dlAnchorElem.setAttribute('download', 'book-entries-' + name + '.json');

                            if (settings.length === 0) {
                                addSetting({ downloaded: new Date() }, function() {});
                            } else {
                                var setting = settings[0];
                                setting.downloaded = new Date();
                                updateSettingRecord(setting, function() { });
                            }

                            dlAnchorElem.click();
                        });
                    }, true);
                })
            }, true);
        }

        function updateProgress(progressMade) {
            $('#progress .progress-bar').html(progressMade + '%');
            $('#progress .progress-bar').css('width', progressMade + '%');
            $('#progress .progress-bar').attr('aria-valuenow', progressMade.toString());
        }

        function openFile(event) {
            updateProgress(1);

            $('#progress').show();
            
            var input = event.target;

            var reader = new FileReader();
            reader.onload = function() {

                $('#bookEntries').hide();
                var json = reader.result;
                var state = JSON.parse(json);
                updateProgress(2);

                var recordsToImport = (state.customers.length + state.bookEntries.length + state.expenses.length) + 2;

                function showProgressToUser() {
                    var recordsImported = (numberOfCustomersImported + numberOfBookEntriesImported + numberOfExpensesImported) + 2;

                    var progressMade = parseInt(Math.floor((recordsImported / recordsToImport) * 100));

                    if (progressMade < 2) {
                        progressMade = 2;
                    }

                    if (progressMade > 99) {
                        progressMade = 99;
                    }

                    updateProgress(progressMade);
                }

                var customersTransaction = db.transaction("customer", "readwrite");
                var customersStore = customersTransaction.objectStore('customer');
                customersStore.clear();

                var numberOfCustomers = 0;
                var numberOfCustomersImported = 0;
                var numberOfBookEntries = 0;
                var numberOfBookEntriesImported = 0;
                var numberOfExpenses = 0;
                var numberOfExpensesImported = 0;

                state.customers.forEach(function(customer) {
                    addCustomer(customer, function() { numberOfCustomersImported++; showProgressToUser(); });
                    numberOfCustomers++;
                });

                var bookyEntryTransaction = db.transaction("bookEntry", "readwrite");
                var bookEntryStore = bookyEntryTransaction.objectStore('bookEntry');
                bookEntryStore.clear();

                state.bookEntries.forEach(function(bookEntry) {
                    bookEntry.when = new Date(bookEntry.when);
                    addBookEntry(bookEntry, function() { numberOfBookEntriesImported++; showProgressToUser(); });
                    numberOfBookEntries++;
                })

                var expensesTransaction = db.transaction("expenses", "readwrite");
                var expensesStore = expensesTransaction.objectStore('expenses');
                expensesStore.clear();

                state.expenses.forEach(function(expense) {
                    expense.when = new Date(expense.when);
                    addExpense(expense, function() { numberOfExpensesImported++; showProgressToUser(); });
                    numberOfExpenses++;
                })

                var interval = setInterval(() => {
                    if (numberOfCustomersImported === numberOfCustomers && numberOfBookEntriesImported === numberOfBookEntries && numberOfExpensesImported === numberOfExpenses) {
                        clearInterval(interval);
                        $('#progress').hide();
                        $("#importForm").get(0).reset();
                        populateBookEntries();
                    }
                }, 100);
            };

            reader.readAsText(input.files[0]);
        };

        function initialiseSettings(callback) {
            getAllSettings(function(settings) {
                if (settings.length === 0) {
                    setting = { 
                        durationInDays: 30,
                        numberOfMonthsToShow: 3
                    };
                    addSetting(setting, callback);
                } else {
                    setting = settings[0];
                    
                    if (setting.durationInDays === undefined || setting.durationInDays === null) {
                        setting.durationInDays = 30;
                    }

                    if (setting.numberOfMonthsToShow === undefined || setting.numberOfMonthsToShow === null) {
                        setting.numberOfMonthsToShow = 3;
                    }

                    updateSettingRecord(setting, callback);
                }
            });
        }

        function promptForDownload() {
            if (!setting.downloaded) {
                alert('You have never backed up data.  Please back up and email to yourself!');
                return;
            }

            var differenceInTime = Math.abs(new Date() - setting.downloaded);
            var days = Math.ceil(differenceInTime / (1000 * 60 * 60 * 24));
            
            if (days >= setting.durationInDays) {
                alert('You have not backed up data for over ' + setting.durationInDays + ' days.  Please back up and email to yourself!');
            }
        }

        function initialise() {
            openRequest = indexedDB.open('BookKeeping', 2);
            
            openRequest.onupgradeneeded = function(event) {
                db = openRequest.result;
                var transaction = event.target.transaction;

                if (!db.objectStoreNames.contains('customer')) {
                    var store = db.createObjectStore('customer', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('full', ['full'], { unique:false });
                }

                if (!db.objectStoreNames.contains('bookEntry'))
                    db.createObjectStore('bookEntry', { keyPath: 'id', autoIncrement: true });

                var bookEntryStore = transaction.objectStore('bookEntry');    
                
                if (!bookEntryStore.indexNames.contains('when')) {
                    bookEntryStore.createIndex('when', ['when'], { unique:false });
                }

                if (!db.objectStoreNames.contains('expenses')) {
                    var store = db.createObjectStore('expenses', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('when', ['when'], { unique:false });
                }

                if (!db.objectStoreNames.contains('settings')) {
                    var store = db.createObjectStore('settings', { keyPath: 'id', autoIncrement: true });
                }
            };

            openRequest.onsuccess = function() {
                db = openRequest.result;

                initialiseSettings(function() {
                    var toDate = new Date().toISOString();
                    toDate = toDate.substr(0, toDate.indexOf('T'));
                    $('#toDate').val(toDate);

                    var today = new moment();
                    var fromDate = today.add('month', -setting.numberOfMonthsToShow);
                    fromDate = fromDate.toISOString();
                    fromDate = fromDate.substr(0, fromDate.indexOf('T'));
                    $('#fromDate').val(fromDate);

                    createCustomer();
                    createBookEntry();
                    updateBookEntry();
                    updateCustomer();
                    createExpense();
                    updateExpense();
                    findCustomer();
                    createSettings();
                    updateSettings();
                    populateBookEntries();
                    dateFilters();

                    $('#downloadButton').click(function() {
                        download();
                    });

                    var date = new Date().toISOString();
                    date = date.substr(0, date.indexOf('T'));
                    $('#defaultWhen').val(date);

                    timeOptions = document.getElementById('whenTime').options;

                    var timeout;
                    $('#filter').on('keyup input', function() {
                        clearTimeout(timeout);
                        timeout = setTimeout(findCustomer, 100);
                    });

                    $('#customerFilter').on('keyup input', function() {
                        clearTimeout(timeout);
                        timeout = setTimeout(findCustomer2, 100);
                    });

                    getAllCustomers(function(customers) {
                        allCustomers = customers;
                        promptForDownload();
                    });
                });
            };
        }

        function customers() {
            currentView = 'customers';
            $('#bookEntry').hide();
            $('#customerDetails').hide();
            $('#findCustomer').hide();
            $('#bookEntries').hide();
            $('#tools').hide();
            $('#expenses').hide();
            $('#dateFiltering').hide();
            $('#expense').hide();
            $('#settings').hide();
            $('#customerFilter').val('');
            $('#customers').show();

            $('#customersBody').empty();

            getAllCustomers(function(customers) {
                allCustomers = customers;

                var html = '';

                customers.forEach(function(customer) {
                    html += getCustomerRow(customer);
                });

                $('#customersBody').append(html);
            });
        }

        function getCustomerRow(customer) {
            return '<tr><td><a href="javascript:editCustomer(' + customer.id + ')">' + customer.name  + '<a/></td><td>' + customer.addressLine1  + '</td><td>' + customer.town + '</td><td>' + customer.postcode + '</td><td>' + customer.miles + '</td></tr>';
        }

        function expenses() {
            currentView = 'expenses';
            $('#bookEntry').hide();
            $('#customerDetails').hide();
            $('#findCustomer').hide();
            $('#bookEntries').hide();
            $('#tools').hide();
            $('#expense').hide();
            $('#dateFiltering').show();
            $('#customers').hide();
            $('#settings').hide();

            $('#expenses').show();

            $('#expensesBody').empty();

            var total = 0;
            var totalMiles = 0;
            var totalMilesCost = 0;

            getAllExpenses(function(expenses) {
                var html = '';

                expenses.forEach(function(expense) {
                    total += expense.amount;
                    totalMiles += expense.miles;
                    totalMilesCost += (expense.miles * costPerMile);
                    html += '<tr><td><a href="javascript:editExpense(' + expense.id + ')">' + getWhen(expense.when) + '<a/></td><td>' + expense.supplier  + '</td><td>' + expense.summary + '</td><td>' + expense.amount.toFixed(2) + '</td><td>' + expense.miles.toFixed(2) + '</td><td><button type="button" class="btn btn-default" onclick="deleteExpense(' + expense.id  + ')">Delete</button></td></tr>';
                });

                $('#totalExpenses').html(total.toFixed(2));
                $('#totalExpenseMiles').html(totalMiles.toFixed(2));
                $('#totalExpenseMilesCost').html(totalMilesCost.toFixed(2));

                $('#expensesBody').append(html);
            });
        }

        function showSettings() {
            currentView = 'settings';
            $('#bookEntry').hide();
            $('#customerDetails').hide();
            $('#findCustomer').hide();
            $('#bookEntries').hide();
            $('#tools').hide();
            $('#expense').hide();
            $('#dateFiltering').hide();
            $('#customers').hide();
            $('#expenses').hide();
            $('#progress').hide();

            $('#settings').show();

            getAllSettings(function(allSettings) {
                setting = allSettings[0];

                editSettings();
            });
        }

        function tools() {
            currentView = 'tools';
            $('#tools').show();
            $('#bookEntries').hide();
            $('#bookEntry').hide();
            $('#findCustomer').hide();
            $('#createCustomerError').hide();
            $('#expenses').hide();
            $('#expense').hide();
            $('#customers').hide();
            $('#dateFiltering').hide();
            $('#settings').hide();
        }

        function collapseDropDownMenu() {
            $('#dropDownMenu').removeClass('in');
        }
        
    </script>
  </head>
  <body>
      <div class="col-md-12" style="padding-left: 0">
        <nav class="navbar navbar-default" style="background-color: #292b2c;margin-bottom: 12px">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#dropDownMenu" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#" onclick="javascript:populateBookEntries();collapseDropDownMenu();return false;" style="color: white">Book Keeping</a>
                </div>
            
                <div class="collapse navbar-collapse" id="dropDownMenu">
                    <ul class="nav navbar-nav">
                        <li><a class="topNavDropDownItem" href="#" onclick="javascript:customers();collapseDropDownMenu();return false;">Customers</a></li>
                        <li><a class="topNavDropDownItem" href="#" onclick="javascript:expenses();collapseDropDownMenu();return false;">Expenses</a></li>
                        <li><a class="topNavDropDownItem" href="#" onclick="javascript:tools();collapseDropDownMenu();return false;">Tools</a></li>
                        <li><a class="topNavDropDownItem" href="#" onclick="javascript:showSettings();collapseDropDownMenu();return false;">Settings</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <div id="scrollTo"></div>
        <div id="dateFiltering">
            <div class="panel-body">
                <div class="form-group">
                    <label for="customer">Data Filtering</label>
                    <br />
                    <div class="col-md-12" style="padding-left: 0; width: 500px">
                        <div class="col-md-6" style="padding-left: 0;width: 170px;float: left">
                            <input id="fromDate" type="date" class="form-control" required="">
                        </div>
                        <div class="col-md-6" style="padding-left: 0;width: 170px;float: left">
                            <input id="toDate" type="date" class="form-control" required="">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tools" class="col-md-12">
            <button id="downloadButton" type="button" class="btn btn-default btn-primary">Download data</button>
            <a id="downloadAnchorElem" style="display:none"></a>
            <br /><br />
            <form id="importForm" name="importForm">
                <strong>Import data:</strong> <input type="file" id="import" name="import" class="btn btn-default" accept="application/json" onchange="openFile(event)">
                <div id="progress" class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 1%;" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100">1%</div>
                </div>
            </form>
        </div>
        
        <div id="customerDetails" class="col-md-12 clear">
            <form autocomplete="off">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Customer Details</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-group" id="nameContainer">
                            <label for="name">Name</label>
                            <input id="name" class="form-control" required="" autofocus="">
                        </div>
                        <div class="form-group" id="addressLine1Container">
                            <label for="addressLine1">Address Line 1</label>
                            <input id="addressLine1" class="form-control" required="">
                        </div>
                        <div class="form-group" id="townContainer">
                            <label for="town">Town</label>
                            <input id="town" class="form-control" required="">
                        </div>
                        <div class="form-group" id="postcodeContainer">
                            <label for="postcode">Postcode</label>
                            <input id="postcode" class="form-control" required="" onClick="this.select();">
                        </div>
                        <div class="form-group" id="milesContainer">
                            <label for="miles">Miles</label>
                            <input id="miles" class="form-control" required="" onClick="this.select();">
                        </div>
                        <div id="createCustomerError" class="alert alert-danger" role="alert">
                            Populate fields correctly!
                        </div>
                        <button id="createCustomer" type="button" class="btn btn-default btn-primary inputMargin" type="submit">Add Customer</button>
                        <button id="updateCustomer" type="button" class="btn btn-default btn-primary inputMargin" type="submit">Update Customer</button>
                    </div>
                </div>
            </form>
        </div>

        <div id="bookEntry" class="col-md-12 clear">
            <form autocomplete="off">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Book entry</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-group" style="display: none">
                            <label for="customerId">Customer Id</label>
                            <input id="customerId" class="form-control" required="" readonly="readonly">
                        </div>
                        <div id="customerContainer" class="form-group">
                            <label for="customer">Customer</label>
                        <input id="customer" class="form-control" required="" readonly="readonly">
                        </div>
                        <div class="form-group" id="whenContainer">
                            <label for="when">When</label>
                            <input id="when" type="date" class="form-control" required="" onchange="javascript:defaultWhen = $('#when').val();">
                            <select id="whenTime" class="form-control" style="margin-top: 8px;">
                                <option>09:00</option>
                                <option>09:15</option>
                                <option>09:30</option>
                                <option>09:45</option>
                                <option>10:00</option>
                                <option>10:15</option>
                                <option>10:30</option>
                                <option>10:45</option>
                                <option>11:00</option>
                                <option>11:15</option>
                                <option>11:30</option>
                                <option>11:45</option>
                                <option>12:00</option>
                                <option>12:15</option>
                                <option>12:30</option>
                                <option>12:45</option>
                                <option>13:00</option>
                                <option>13:15</option>
                                <option>13:30</option>
                                <option>13:45</option>
                                <option>14:00</option>
                                <option>14:15</option>
                                <option>14:30</option>
                                <option>14:45</option>
                                <option>15:00</option>
                                <option>15:15</option>
                                <option>15:30</option>
                                <option>15:45</option>
                                <option>16:00</option>
                                <option>16:15</option>
                                <option>16:30</option>
                                <option>16:45</option>
                                <option>17:00</option>
                                <option>17:15</option>
                                <option>17:30</option>
                                <option>17:45</option>
                                <option>18:00</option>
                                <option>18:15</option>
                                <option>18:30</option>
                                <option>18:45</option>
                                <option>19:00</option>
                                <option>19:15</option>
                                <option>19:30</option>
                                <option>19:45</option>
                                <option>20:00</option>
                                <option>20:15</option>
                                <option>20:30</option>
                                <option>20:45</option>
                                <option>21:00</option>
                            </select>
                        </div>
                        <div class="form-group" id="summaryContainer">
                            <label for="summary">Summary of work</label>
                            <input id="summary" class="form-control" required="">
                        </div>
                        <div class="form-group" id="amountContainer">
                            <label for="amount">Amount (e.g. 12.95)</label>
                            <input id="amount" class="form-control"required="">
                        </div>
                        <div id="createBookEntryError" class="alert alert-danger" role="alert">
                            Populate fields correctly!
                        </div>
                        <button id="createBookEntry" type="button" class="btn btn-default btn-primary inputMargin" type="submit">Add Book Entry</button>
                        <button id="updateBookEntry" type="button" class="btn btn-default btn-primary inputMargin" type="submit">Update Book Entry</button>
                    </div>
                </div>
            </form>
        </div>

        <div id="expense" class="col-md-12 clear">
            <form autocomplete="off">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Expense</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-group" id="expenseWhenContainer">
                            <label for="expenseWhen">When</label>
                            <input id="expenseWhen" type="date" class="form-control" required="">
                        </div>
                        <div class="form-group" id="expenseSupplierContainer">
                            <label for="expenseSupplier">Supplier</label>
                            <input id="expenseSupplier" class="form-control" required="">
                        </div>
                        <div class="form-group" id="expenseSummaryContainer">
                            <label for="expenseSummary">Summary of supplies</label>
                            <input id="expenseSummary" class="form-control" required="">
                        </div>
                        <div class="form-group" id="expenseAmountContainer">
                            <label for="expenseAmount">Amount (e.g. 12.95)</label>
                            <input id="expenseAmount" class="form-control"required="">
                        </div>
                        <div class="form-group" id="expenseMilesContainer">
                            <label for="expenseMiles">Miles</label>
                            <input id="expenseMiles" class="form-control" required="" onClick="this.select();">
                        </div>
                        <div id="createExpenseError" class="alert alert-danger" role="alert">
                            Populate fields correctly!
                        </div>
                        <button id="createExpense" type="button" class="btn btn-default btn-primary inputMargin" type="submit">Add Expense</button>
                        <button id="updateExpense" type="button" class="btn btn-default btn-primary inputMargin" type="submit">Update Expense</button>
                    </div>
                </div>
            </form>
        </div>

        <div id="settings" class="col-md-12 clear">
            <form autocomplete="off">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Settings</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-group" id="reminderDurationInDaysContainer">
                            <label for="reminderDuartionInDays">Download reminder (days)</label>
                            <input id="reminderDurationInDays" class="form-control" required="">
                        </div>
                        <div class="form-group" id="numberOfMonthsToShowContainer">
                            <label for="numberOfMonthsToShow">Number of months to show</label>
                            <input id="numberOfMonthsToShow" class="form-control" required="">
                        </div>
                        <button id="updateSettings" type="button" class="btn btn-default btn-primary inputMargin" type="submit">Update Settings</button>
                    </div>
                </div>
            </form>
        </div>

        <div id="findCustomer" class="col-md-12 clear">
            <form autocomplete="off">
                <div class="panel panel-default clear">
                    <div class="panel-heading">
                        <h3 class="panel-title">Find Customer <button id="createCustomerModal3" type="button" class="btn btn-default btn-primary">Customer +</button></h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="filter" class="sr-only">Search filter</label>
                            <input id="filter" class="form-control" required="" autofocus="">
                        </div>
                        <div id="results">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Select</th>
                                        <th>Name</th>
                                        <th>Address line 1</th>
                                        <th>Town</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div id="bookEntries" class="col-md-12 clear">
            <div class="col-md-12 clear createButtons">
                <button id="createBookEntryModal" type="button" class="btn btn-default btn-primary">Entry +</button>
                <button id="createCustomerModal" type="button" class="btn btn-default btn-primary">Customer +</button>
            </div>
            <div id="bookEntriesSummary">
                <h4 style="padding-top: 5px">Total Income: £<span id="total"></span></h4>
                <h4>Total Miles: <span id="totalMiles"></span></h4>
                <h4>Total Miles Cost: £<span id="totalMilesCost"></span></h4>
            </div>
            <div id="bookEntriesBody"></div>
        </div>
    </div>

    <div id="customers" class="col-md-12 clear">
        <div class="col-md-12 clear createButtons">
            <button id="createBookEntryModal2" type="button" class="btn btn-default btn-primary">Entry +</button>
            <button id="createCustomerModal2" type="button" class="btn btn-default btn-primary">Customer +</button>
        </div>
        <form autocomplete="off">
            <div class="panel panel-default clear">
                <div class="panel-heading">
                    <h3 class="panel-title">Customers</h3>
                </div>
                <div class="panel-body">
                    <div class="form-group">
                        <label for="customerFilter">Search filter</label>
                        <input id="customerFilter" class="form-control" required="" autofocus="">
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Address line 1</th>
                                <th>Town</th>
                                <th>Postcode</th>
                                <th>Miles</th>
                            </tr>
                        </thead>
                        <tbody id="customersBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </form>
    </div>

    <div id="expenses" class="col-md-12 clear">
        <div id="expensesButtons" class="col-md-12 clear">
            <button id="createExpenseModal" type="button" class="btn btn-default btn-primary">Expense +</button>
        </div>
        <div>
            <h4 style="padding-top: 5px">Total Expenses: £<span id="totalExpenses"></span></h4>
            <h4>Total Miles: <span id="totalExpenseMiles"></span></h4>
            <h4>Total Miles Cost: £<span id="totalExpenseMilesCost"></span></h4>
        </div>
        <div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Supplier</th>
                        <th>Summary</th>
                        <th>Amount</th>
                        <th>Miles</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="expensesBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="jquery-1.12.4.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="bootstrap.min.js"></script>
    <script src="moment.min.js"></script>
    <script type="text/JavaScript">
    $(function() {
        initialise();
    });
    </script>
  </body>
</html>
