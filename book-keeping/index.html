<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Book Keeping</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
        .clear {
            clear: both;
        }
        .inputMargin {
            margin-top:5px;
        }
        .marginBottom {
            margin-bottom: 5px;
        }
        #customerDetails, #createCustomerError, #searchError, #results, #findCustomer, #createBookEntryError {
            display: none;
        }

        #bookEntry {
            display: none;
        }

        input[type=file] {
            display: inline-block;
        }
    </style>
    <script type="text/JavaScript">
        var openRequest;
        var db;
        var miles = 0;
        var timeOptions = [];
        var bookEntry;

        function addCustomer(customer, successCallback) {
            var customersTransaction = db.transaction("customer", "readwrite");
            var customersStore = customersTransaction.objectStore('customer');

            let request = customersStore.add(customer);

            request.onsuccess = successCallback;
        }

        function addBookEntry(bookEntry, successCallback) {
            var bookyEntryTransaction = db.transaction("bookEntry", "readwrite");
            var bookEntryStore = bookyEntryTransaction.objectStore('bookEntry');

            let request = bookEntryStore.add(bookEntry);

            request.onsuccess = successCallback;
        }

        function updateBookEntryRecord(bookEntry, successCallback) {
            var bookyEntryTransaction = db.transaction("bookEntry", "readwrite");
            var bookEntryStore = bookyEntryTransaction.objectStore('bookEntry');

            let request = bookEntryStore.put(bookEntry);

            request.onsuccess = successCallback;
            request.onerror = function(err) {
                console.log(err);
            }
        }

        function createCustomer() {
            $('#createCustomerModal').click(function() {
                $('#bookEntries').hide();
                $('#bookEntry').hide();
                $('#findCustomer').hide();
                $('#createCustomerError').hide();
                $('#name').val('');
                $('#addressLine1').val('');
                $('#town').val('');
                $('#postcode').val('.');
                $('#miles').val('0');
                $('#customerDetails').show();
                $('#name').focus();
            });

            $('#createCustomer').click(function() {
                $('#createCustomerError').hide();
                var name = $('#name').val().trim();
                var addressLine1 = $('#addressLine1').val().trim();
                var town = $('#town').val().trim();
                var postcode = $('#postcode').val().trim();
                var miles = $('#miles').val().trim();

                let milesRegEx = new RegExp(/^[0-9]+(\.[0-9]{1,2}){0,1}$/);

                if (name.length === 0 || addressLine1.length === 0 || town.length === 0 || postcode.length === 0 || !milesRegEx.test(miles)) {
                    $('#createCustomerError').show();
                    return;
                }

                var customer = {
                    name: name,
                    addressLine1: addressLine1,
                    town: town,
                    postcode: postcode,
                    miles: parseFloat(miles),
                    full: (name + addressLine1 + town + postcode).toLowerCase()
                };
                
                addCustomer(customer, function() {
                    $('#customerDetails').hide();
                    $('#createBookEntryModal')[0].scrollIntoView();
                });
            });
        }

        function createBookEntry() {
            $('#createBookEntryModal').click(function() {
                $('#createBookEntry').show();
                $('#updateBookEntry').hide();
                $('#bookEntries').hide();
                $('#createBookEntryError').hide();
                $('#customerDetails').hide();
                $('#findCustomer').hide();
                $('#bookEntry').show();

                $('#customerId').val('');
                $('#when').val($('#defaultWhen').val());
                document.getElementById('whenTime').selectedIndex = 0;
                $('#amount').val('');
                $('#summary').val('');
            });

            $('#customerId').click(function() {
                $('#bookEntry').hide();
                showFindCustomer();
            });

            $('#createBookEntry').click(function() {
                var customerId = $('#customerId').val().trim();
                var when = $('#when').val();
                var whenTime = $('#whenTime').val();
                var amount = $('#amount').val();
                var summary = $('#summary').val();

                let moneyRegEx = new RegExp(/^[0-9]+(\.[0-9]{2}){0,1}$/);

                var valid = customerId.length > 0 && when.length > 0 && moneyRegEx.test(amount) && summary.length > 0;

                if (!valid) {
                    $('#createBookEntryError').show();
                    return;
                }

                if (miles === undefined || miles === null)
                    miles = 0;

                var bookEntry = {
                    customer: customerId,
                    when: new Date(when + 'T' + whenTime),
                    summary: summary,
                    amount: parseFloat(amount),
                    miles: parseFloat(miles)
                };

                addBookEntry(bookEntry, function() {
                    $('#bookEntry').hide();
                    $('#createBookEntryModal')[0].scrollIntoView();
                    populateBookEntries();
                });
            });
        }

        function editBookEntry(id, milesVal) {
            miles = milesVal;
            getBookEntryById(id, function(bookEntryInstance) {
                bookEntry = bookEntryInstance;
                $('#bookEntries').hide();
                $('#createBookEntryError').hide();
                $('#customerDetails').hide();
                $('#findCustomer').hide();
                $('#bookEntry').show();
                $('#createBookEntry').hide();
                $('#updateBookEntry').show();

                $('#customerId').val(bookEntry.customer);
                var when = bookEntry.when.toISOString();
                var date = when.substr(0, when.indexOf('T'));
                $('#when').val(date);
                $('#amount').val(bookEntry.amount.toString());
                $('#summary').val(bookEntry.summary);

                document.getElementById('whenTime').selectedIndex = 0;

                var time = when.substr(when.indexOf('T') + 1);
                time = time.substr(0, 5);

                for (var i = 0; i < timeOptions.length; i++) {
                    if (timeOptions[i].text === time) {
                        document.getElementById('whenTime').selectedIndex = i;
                        break;
                    }
                }
            })
        }

        function updateBookEntry() {
            $('#updateBookEntry').click(function() {
                console.log('1');
                var customerId = $('#customerId').val().trim();
                var when = $('#when').val();
                var whenTime = $('#whenTime').val();
                var amount = $('#amount').val();
                var summary = $('#summary').val();

                let moneyRegEx = new RegExp(/^[0-9]+(\.[0-9]{2}){0,1}$/);

                var valid = customerId.length > 0 && when.length > 0 && moneyRegEx.test(amount) && summary.length > 0;

                if (!valid) {
                    $('#createBookEntryError').show();
                    return;
                }

                if (miles === undefined || miles === null)
                    miles = 0;

                bookEntry.customer = customerId;
                bookEntry.when = new Date(when + 'T' + whenTime);
                bookEntry.summary = summary;
                bookEntry.amount = parseFloat(amount);
                bookEntry.miles = parseFloat(miles);

                console.log('here', bookEntry);

                updateBookEntryRecord(bookEntry, function() {
                    console.log('here2');
                    $('#bookEntry').hide();
                    $('#createBookEntryModal')[0].scrollIntoView();
                    populateBookEntries();
                });
            });
        }

        function showFindCustomer() {
            $('#findCustomer').show();
            $('#selectCustomer').hide();
            $('#filter').val('');
            $('#resultsBody').empty();
            $('#results').hide();
            $('#filter').focus();
            $('#createBookEntryModal')[0].scrollIntoView();
        }

        function findCustomer() {
            $('#search').click(function() {
                $('#resultsBody').empty();
                $('#searchError').hide();

                var filter = $('#filter').val().trim().toLowerCase();

                if (filter.length === 0) {
                    $('#searchError').show();
                    return;
                }

                var html = '';

                getAllCustomers(function(customers) {
                    customers = customers.filter(function(item) {return item.full.indexOf(filter) !== -1; });

                    customers.forEach(function(customer) {
                        html += '<tr><td><input type="radio" name="customerradio" value="' + customer.id + '" data-miles="' + customer.miles + '" data-summary="' + customer.name + ', ' + customer.addressLine1 + ', ' + customer.town + '"></td><td>' + customer.name  + '</td><td>' + customer.addressLine1  + '</td><td>' + customer.town + '</td></tr>';
                    });

                    $('#results').show();
                    $('#resultsBody').append(html);

                    if (customers.length > 0) {
                        $('#selectCustomer').show();
                    }
                });
            });

            $('#selectCustomer').click(function() {
                var input = $("input:radio[name='customerradio']:checked");

                var id = input.val();

                if (id === undefined) return;

                $('#findCustomer').hide();
                $('#bookEntry').show();
                $('#customerId').val(id + ' - ' + input.data().summary);
                miles = parseFloat(input.data().miles)
            });
        }

        function orderBookEntries(bookEntries) {
            // could probably be done via an index somehow on query!!!!!!!!!!
            var sortedBookEntries = bookEntries.sort(function(a, b){
                return b.when - a.when; 
                }
            );

            return sortedBookEntries;
        }

        function getFormattedDate(date) {
            var year = date.getFullYear();

            var month = (1 + date.getMonth()).toString();
            month = month.length > 1 ? month : '0' + month;

            var day = date.getDate().toString();
            day = day.length > 1 ? day : '0' + day;

            var hour = date.getHours().toString();
            hour = hour.length > 1 ? hour : '0' + hour
            
            var minute = date.getMinutes().toString();
            minute = minute.length > 1 ? minute : '0' + minute;
            
            return day + '/' + month + '/' + year + ' ' + hour + ':' + minute;
        }

        var deleting = false;
        function deleteBookEntry(index) {
            if (deleting) return;

            var result = confirm('Are you sure?');

            if (!result) return;

            deleting = true;
            
            var bookEntriesTransaction = db.transaction("bookEntry", "readwrite");
            var bookEntriesStore = bookEntriesTransaction.objectStore('bookEntry');

            var request = bookEntriesStore.delete(index);

            request.onsuccess = function(event) {
                populateBookEntries();
                deleting = false;
            };
        }

        function getAllBookEntries(successCallback) {
            var bookEntriesTransaction = db.transaction("bookEntry", "readwrite");
            var bookEntriesStore = bookEntriesTransaction.objectStore('bookEntry');
            var allRecords = bookEntriesStore.getAll();

            allRecords.onsuccess = function() {
                successCallback(allRecords.result);
            };
        }

        function getAllCustomers(successCallback) {
            var customersTransaction = db.transaction("customer", "readwrite");
            var customersStore = customersTransaction.objectStore('customer');
            var allRecords = customersStore.getAll();

            allRecords.onsuccess = function() { 
                successCallback(allRecords.result);
            };
        }

        function getBookEntryById(id, successCallback) {
            var bookEntriesTransaction = db.transaction("bookEntry", "readwrite");
            var bookEntriesStore = bookEntriesTransaction.objectStore('bookEntry');
            var record = bookEntriesStore.get(id);

            record.onsuccess = function() {
                successCallback(record.result);
            };
        }

        function populateBookEntries() {
            var html = "";
            var total = 0;
            var totalMiles = 0;

            getAllBookEntries(function(bookEntries) {
                var bookEntries = orderBookEntries(bookEntries);

                bookEntries.forEach(function(bookEntry) {
                    var miles = bookEntry.miles;

                    if (miles === undefined || miles === null)
                        miles = 0;

                    html += '<tr><td>' + getFormattedDate(bookEntry.when) + '</td><td>' + bookEntry.customer + '</td><td>£' + bookEntry.amount.toFixed(2) + '</td><td>' + miles + '</td><td>' + bookEntry.summary + '</td><td><button type="button" class="btn btn-default" onclick="editBookEntry(' + bookEntry.id  + ', ' + miles + ')">Edit</button></td><td><button type="button" class="btn btn-default" onclick="deleteBookEntry(' + bookEntry.id  + ')">Delete</button></td></tr>';
                    total += bookEntry.amount;
                    totalMiles += miles;
                });
                
                $('#bookEntriesBody').html(html)
                $('#bookEntries').show();
                $('#total').html(total.toFixed(2));
                $('#totalMiles').html(totalMiles.toFixed(2));
            });
        }

        function download() {
            getAllBookEntries(function(bookEntries) {
                getAllCustomers(function(customers) {
                    var data = {
                        bookEntries: bookEntries,
                        customers: customers
                    };

                    var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
                    var dlAnchorElem = document.getElementById('downloadAnchorElem');
                    dlAnchorElem.setAttribute("href", dataStr);
                    var name = getFormattedDate(new Date());
                    name = name.replace(' ', '_');
                    name = name.replace(':', '-');
                    name = name.replace(/\//g, '-');
                    dlAnchorElem.setAttribute('download', 'book-entries-' + name + '.json');
                    dlAnchorElem.click();
                })
            });
        }

        function openFile(event) {
            var input = event.target;

            var reader = new FileReader();
            reader.onload = function() {
                var json = reader.result;
                var state = JSON.parse(json);

                var customersTransaction = db.transaction("customer", "readwrite");
                var customersStore = customersTransaction.objectStore('customer');
                customersStore.clear();

                state.customers.forEach(function(customer) {
                    addCustomer(customer, function() {});
                })

                var bookyEntryTransaction = db.transaction("bookEntry", "readwrite");
                var bookEntryStore = bookyEntryTransaction.objectStore('bookEntry');
                bookEntryStore.clear();

                state.bookEntries.forEach(function(bookEntry) {
                    bookEntry.when = new Date(bookEntry.when);
                    addBookEntry(bookEntry, function() {});
                })

                populateBookEntries();
            };

            reader.readAsText(input.files[0]);
        };

        function initialise() {
            openRequest = indexedDB.open('BookKeeping', 1);
            
            openRequest.onupgradeneeded = function() {
                db = openRequest.result;
                if (!db.objectStoreNames.contains('customer')) {
                    var store = db.createObjectStore('customer', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('full', ['full'], { unique:false });
                }

                if (!db.objectStoreNames.contains('bookEntry'))
                    db.createObjectStore('bookEntry', { keyPath: 'id', autoIncrement: true });
            };

            openRequest.onsuccess = function() {
                db = openRequest.result;

                createCustomer();
                createBookEntry();
                updateBookEntry();
                findCustomer();
                populateBookEntries();

                $('#downloadButton').click(function() {
                    download();
                });

                var date = new Date().toISOString();
                date = date.substr(0, date.indexOf('T'));
                $('#defaultWhen').val(date);

                timeOptions = document.getElementById('whenTime').options;
            };
        }
        
    </script>
  </head>
  <body>
      <div class="col-md-12">
        <h1>Book Keeping</h1>

        <div class="col-md-12">
            <input type="file" id="import" name="import" class="btn btn-default" accept="application/json" onchange="openFile(event)">
            <button id="downloadButton" type="button" class="btn btn-default">Download</button>
            <br /><br />
        </div>
        <div class="col-md-3 clear">
            Default date:<input id="defaultWhen" type="date" class="form-control inputMargin" required="" placeholder="When">
        </div>
        <div class="col-md-3 clear inputMargin marginBottom">
            <button id="createBookEntryModal" type="button" class="btn btn-default">Create Book Entry</button>
            <button id="createCustomerModal" type="button" class="btn btn-default">Create Customer</button>
        </div>
        
        <a id="downloadAnchorElem" style="display:none"></a>
        <div id="customerDetails" class="col-md-12 clear">
            <form autocomplete="off">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Customer Details</h3>
                    </div>
                    <div class="panel-body">
                        <label for="inputEmail" class="sr-only">Name</label>
                        <input id="name" class="form-control" placeholder="Name" required="" autofocus="">
                        <label for="addressLine1" class="sr-only">Address Line 1</label>
                        <input id="addressLine1" class="form-control inputMargin" placeholder="Address Line 1" required="">
                        <label for="town" class="sr-only">Town</label>
                        <input id="town" class="form-control inputMargin" placeholder="Town" required="">
                        <label for="postcode" class="sr-only">Address Line 1</label>
                        <input id="postcode" class="form-control inputMargin" placeholder="Postcode" required="" onClick="this.select();">
                        <label for="miles" class="sr-only">Miles</label>
                        <input id="miles" class="form-control inputMargin" placeholder="Miles" required="" onClick="this.select();">
                        <div id="createCustomerError" class="alert alert-danger inputMargin" role="alert">
                            Populate fields correctly!
                        </div>
                        <button id="createCustomer" type="button" class="btn btn-default inputMargin" type="submit">Add Customer</button>
                    </div>
                </div>
            </form>
        </div>

        <div id="bookEntry" class="col-md-12 clear">
            <form autocomplete="off">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Book entry</h3>
                    </div>
                    <div class="panel-body">
                        <label for="customerId" class="sr-only">Customer</label>
                        <input id="customerId" class="form-control" placeholder="Click here to find a customer" required="" readonly="readonly">
                        <label for="when" class="sr-only">When</label>
                        <div class="col-md-4" style="margin-bottom: 5px">
                            <input id="when" type="date" class="form-control inputMargin" required="" placeholder="When">
                            <select id="whenTime" class="form-control inputMargin">
                                <option>09:00</option>
                                <option>09:15</option>
                                <option>09:30</option>
                                <option>09:45</option>
                                <option>10:00</option>
                                <option>10:15</option>
                                <option>10:30</option>
                                <option>10:45</option>
                                <option>11:00</option>
                                <option>11:15</option>
                                <option>11:30</option>
                                <option>11:45</option>
                                <option>12:00</option>
                                <option>12:15</option>
                                <option>12:30</option>
                                <option>12:45</option>
                                <option>13:00</option>
                                <option>13:15</option>
                                <option>13:30</option>
                                <option>13:45</option>
                                <option>14:00</option>
                                <option>14:15</option>
                                <option>14:30</option>
                                <option>14:45</option>
                                <option>15:00</option>
                                <option>15:15</option>
                                <option>15:30</option>
                                <option>15:45</option>
                                <option>16:00</option>
                                <option>16:15</option>
                                <option>16:30</option>
                                <option>16:45</option>
                                <option>17:00</option>
                                <option>17:15</option>
                                <option>17:30</option>
                                <option>17:45</option>
                                <option>18:00</option>
                                <option>18:15</option>
                                <option>18:30</option>
                                <option>18:45</option>
                                <option>19:00</option>
                                <option>19:15</option>
                                <option>19:30</option>
                                <option>19:45</option>
                                <option>20:00</option>
                                <option>20:15</option>
                                <option>20:30</option>
                                <option>20:45</option>
                                <option>21:00</option>
                            </select>
                        </div>
                        <label for="summary" class="sr-only">Summary of work</label>
                        <input id="summary" class="form-control inputMargin" placeholder="Enter the summary of work" required="">
                        <label for="amount" class="sr-only">Amount</label>
                        <input id="amount" class="form-control inputMargin" placeholder="Enter the amount e.g. 12.95" required="">
                        <div id="createBookEntryError" class="alert alert-danger inputMargin" role="alert">
                            Populate fields correctly!
                        </div>
                        <button id="createBookEntry" type="button" class="btn btn-default inputMargin" type="submit">Add Book Entry</button>
                        <button id="updateBookEntry" type="button" class="btn btn-default inputMargin" type="submit">Update Book Entry</button>
                    </div>
                </div>
            </form>
        </div>

        <div id="findCustomer" class="col-md-12 clear">
            <form autocomplete="off">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Find Customer</h3>
                    </div>
                    <div class="panel-body">
                        <label for="filter" class="sr-only">Filter</label>
                        <input id="filter" class="form-control" placeholder="Enter search filter" required="" autofocus="">
                        <button id="search" type="button" class="btn btn-default inputMargin">Search</button>
                        <div id="searchError" class="alert alert-danger inputMargin" role="alert">
                            Enter a search filter!
                        </div>
                        <div id="results">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Select</th>
                                        <th>Name</th>
                                        <th>Address line 1</th>
                                        <th>Town</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsBody">
                                </tbody>
                            </table>
                        </div>
                        <button id="selectCustomer" type="button" class="btn btn-default inputMargin">Select customer</button>
                    </div>
                </div>
            </form>
        </div>

        <div id="bookEntries" class="col-md-12 clear">
            <h3 style="padding-top: 5px">Total Amount: £<span id="total"></span></h3>
            <h3>Total Miles: <span id="totalMiles"></span></h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Miles</th>
                        <th>Summary of work</th>
                        <th>Edit</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="bookEntriesBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ" crossorigin="anonymous"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
    <script type="text/JavaScript">
    $(function() {
        initialise();
    });
    </script>
  </body>
</html>
